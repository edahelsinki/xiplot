{"version":3,"sources":["worker.ts"],"names":[],"mappings":"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","file":"worker.9b3b46df.js","sourceRoot":"../src","sourcesContent":["/**\n * Based on Itay Dafna's https://github.com/ibdafna/webdash/releases/tag/0.0.3\n *\n * BSD 3-Clause License\n *\n * Copyright (c) 2021, Bloomberg LP\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met:\n *\n * 1. Redistributions of source code must retain the above copyright notice, this\n *    list of conditions and the following disclaimer.\n *\n * 2. Redistributions in binary form must reproduce the above copyright notice,\n *    this list of conditions and the following disclaimer in the documentation\n *    and/or other materials provided with the distribution.\n *\n * 3. Neither the name of the copyright holder nor the names of its\n *    contributors may be used to endorse or promote products derived from\n *    this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\n * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE\n * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\n * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR\n * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER\n * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,\n * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimportScripts(\"pyodide.js\");\n\n/**\n * Handler receiving message events from the WorkerManager.\n *\n * @param event the message\n */\nonmessage = async (event: MessageEvent) => {\n  const pyodide = await maybe_pyodide;\n\n  const { python, ...context } = event.data;\n  const python_code: string = python;\n\n  // The worker copies the context in its own \"memory\" (an object mapping name to values)\n  for (const key of Object.keys(context)) {\n    self[key] = context[key];\n  }\n\n  // Load imported packages into the Pyodide interpreter\n  await pyodide.loadPackagesFromImports(\n    python_code,\n    postConsoleMessage,\n    postConsoleError\n  );\n\n  // Execute the Python code\n  let result = await pyodide.runPython(python_code);\n\n  // Check if the result is a PyProxy, if so convert it into a response object\n  if (pyodide.isPyProxy(result)) {\n    result = responseObjectFromPython(result);\n  }\n\n  try {\n    postResponseMessage(result);\n  } catch (error) {\n    postErrorMessage(error.message);\n  }\n};\n\n/**\n * The global Pyodide interpreter interface.\n */\nconst maybe_pyodide: Promise<PyodideInterface> = loadPyodide({\n  homedir: \"/\",\n  indexURL: \"\",\n  fullStdLib: false,\n  stdout: postConsoleMessage,\n  stderr: postConsoleError,\n});\n\n/**\n * Transforms a `PyProxy` response from Flask into an object\n * containing the response headers, body, and status code.\n *\n * @param python_response the `PyProxy` response\n *\n * @returns the response object\n */\nfunction responseObjectFromPython(python_response: PyProxy): {\n  response: string | Uint8Array | null;\n  status: number;\n  headers: { [key: string]: string };\n} {\n  let as_text;\n  const js_response = python_response.get_data((as_text = false)).toJs();\n\n  const decoder = new TextDecoder(\"utf-8\", { fatal: true });\n\n  // Attempt to decode the message as a string, otherwise leave it as is\n  let response: string | Uint8Array | null = null;\n  if (js_response) {\n    try {\n      response = decoder.decode(js_response);\n    } catch (_) {\n      response = js_response;\n    }\n  }\n\n  const status: number = python_response.status_code;\n\n  const header_keys: PyProxy & Iterable<string> =\n    python_response.headers.keys();\n  const headers = Array.from(header_keys).reduce(\n    (acc: object, val: string) => (\n      (acc[val] = python_response.headers.get(val)), acc\n    ),\n    {}\n  );\n\n  // Clean up the PyProxy objects to avoid a memory leak\n  header_keys.destroy();\n  python_response.destroy();\n\n  return {\n    response,\n    status,\n    headers,\n  };\n}\n\n/**\n * Post a response message to the WorkerManager.\n *\n * @param results the response\n */\nfunction postResponseMessage(results: any) {\n  self.postMessage({\n    results,\n  });\n}\n\n/**\n * Post an error message to the WorkerManager.\n *\n * @param error the error message\n */\nfunction postErrorMessage(error: any) {\n  self.postMessage({\n    error,\n  });\n}\n\n/**\n * Post a message to `console.log`\n *\n * @param consoleMessage the string message\n */\nfunction postConsoleMessage(consoleMessage: string) {\n  self.postMessage({\n    consoleMessage,\n  });\n}\n\n/**\n * Post a message to `console.error`\n *\n * @param consoleError the string error message\n */\nfunction postConsoleError(consoleError: string) {\n  self.postMessage({\n    consoleError,\n  });\n}\n\n/*\n * Reduced minimal type declarations for Pyodide.\n *\n * Extracted from pyodide.d.ts in\n * https://github.com/pyodide/pyodide/releases/tag/0.21.0a3\n */\n\ndeclare function loadPyodide(options?: {\n  indexURL?: string;\n  homedir?: string;\n  fullStdLib?: boolean;\n  stdout?: (msg: string) => void;\n  stderr?: (msg: string) => void;\n}): Promise<PyodideInterface>;\n\ndeclare type PyodideInterface = {\n  loadPackagesFromImports: (\n    code: string,\n    stdout?: (msg: string) => void,\n    stderr?: (err: string) => void\n  ) => Promise<void>;\n  isPyProxy: (jsobj: any) => jsobj is PyProxy;\n  runPython: (code: string) => any;\n  runPythonAsync: (code: string) => Promise<any>;\n};\n\ndeclare type PyProxy = PyProxyClass & {\n  [x: string]: any;\n};\n\ndeclare class PyProxyClass {\n  destroy(): void;\n  toJs(): any;\n}\n"]}